# Based on Debian (node:14 image)
FROM node:14

ARG NODE_USER
ARG RABBITMQ_URL_PRODUCTION
ARG INVENTORY_API_URL_PRODUCTION
ARG PGHOST
ARG GATEWAY_HOST
ARG GATEWAY_PORT
ARG RABBITMQ_QUEUE
ARG RABBITMQ_URL

RUN echo "NODE_USER=$NODE_USER"
RUN echo "RABBITMQ_URL_PRODUCTION=$RABBITMQ_URL_PRODUCTION"
RUN echo "INVENTORY_API_URL_PRODUCTION=$INVENTORY_API_URL_PRODUCTION"
RUN echo "PGHOST=$PGHOST"
RUN echo "GATEWAY_HOST=$GATEWAY_HOST"
RUN echo "GATEWAY_PORT=$GATEWAY_PORT"
RUN echo "RABBITMQ_QUEUE=$RABBITMQ_QUEUE"
RUN echo "RABBITMQ_URL=$RABBITMQ_URL"

ENV NODE_USER=$NODE_USER
ENV RABBITMQ_URL_PRODUCTION=$RABBITMQ_URL_PRODUCTION
ENV INVENTORY_API_URL_PRODUCTION=$INVENTORY_API_URL_PRODUCTION
ENV PGHOST=$PGHOST
ENV GATEWAY_HOST=$GATEWAY_HOST
ENV GATEWAY_PORT=$GATEWAY_PORT
ENV RABBITMQ_QUEUE=$RABBITMQ_QUEUE
ENV RABBITMQ_URL=$RABBITMQ_URL

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

# Create the user if it doesn't exist
RUN if [ -n "$NODE_USER" ] && ! id -u "$NODE_USER" >/dev/null 2>&1; then \
    adduser --disabled-password --gecos "" "$NODE_USER"; \
    fi

RUN mkdir -p /var/log/api-gateway && chown -R ${NODE_USER}:${NODE_USER} /var/log/api-gateway

USER ${NODE_USER}

EXPOSE 3000

CMD ["node", "src/server.js"]
